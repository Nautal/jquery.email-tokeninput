!function(e){e.fn.mailToken=function(n){function i(n){w=e(n),w.addClass("mt-container"),t(),s(),l(),w.append('<div style="clear:both;"></div>')}function t(){var n=e("<textarea/>",{style:"display:none;",name:Z.name});w.append(n),x=w.find("textarea")}function l(){var n=e("<ul/>",{"class":"mt-ul"});w.prepend(n),A=w.find(n)}function a(){if(o())return void h();var n=e("<li/>",{"class":"mt-token",html:g.val()});A.append(n),k()}function o(){if(""==g.val()||void 0==g.val())return!0;var n=!1;return A.children("li").each(function(){e(this).html()==g.val()&&(n=!0)}),n}function c(){var e=g.val();return e.match(Z.regex)}function s(){var n=e("<input/>",{style:"display:none;",name:Z.name+"-input","data-autosize-input":'{ "space" : 0}',blur:function(){u(e(this))}});w.append(n),g=w.find("input")}function u(e){(""==e.val()||void 0==e.val)&&e.hide()}function r(){w.click(y),w.click(function(){A.children("li").removeClass("mt-selected")}),g.on("keydown",v),document.addEventListener("keydown",d)}function d(n){13==n.keyCode&&f(n),8==n.keyCode&&(g.is(":visible")||(e(".mt-selected").remove(),A.children("li:last").addClass("mt-selected"))),27==n.keyCode&&(g.val(""),g.hide(),A.children("li").removeClass("mt-selected")),39==n.keyCode&&(g.is(":visible")||(g.show(),g.focus(),A.children("li").removeClass("mt-selected")))}function f(e){g.is(":visible")&&e.preventDefault(),g.is(":visible")&&!g.is(":focus")&&(h(),g.focus())}function v(e){13==e.keyCode&&m(),8==e.keyCode&&u(g)}function m(){return c()?(p(),a(),void C()):void h()}function h(){g.addClass("mt-error")}function p(){g.removeClass("mt-error")}function y(){g.show(),g.focus()}function k(){g.val("")}function C(){var e=JSON.stringify(b());x.val(e)}function b(){var n=[];return A.children("li").each(function(){n.push({email:e(this).html()})}),n}var w=null,x=null,g=null,A=null,Z={name:"emailtoken",regex:/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i};return this.each(function(){i(this),r()})}}(jQuery);
